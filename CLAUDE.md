# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Arena Dona Santa** is a comprehensive web platform for managing sports arena reservations. The system features autonomous team management, flexible cost sharing, public invitations, and modules for regular reservations (CORE), sports school classes (Escolinha), and day-use packages (Day Use).

### Tech Stack

**Frontend:**
- Next.js 14+ (App Router)
- TypeScript
- Tailwind CSS
- shadcn/ui components
- React Query (TanStack Query)
- Zod validation
- React Hook Form

**Backend:**
- Supabase (BaaS)
- PostgreSQL (Supabase)
- Supabase Auth
- Supabase Storage
- Supabase Edge Functions

**Deployment:**
- Cloudflare Pages

**Integrations:**
- Asaas (Brazilian payment gateway)
- WhatsApp Business API
- ViaCEP (Brazilian postal code API)

## Architecture

### Modular Structure

The application follows a modular architecture with three main modules:

1. **CORE Module** - Primary reservation system with autonomous teams, flexible cost sharing (percentage or fixed value), and public invitations
2. **Escolinha Module** - Sports school management with classes, students, attendance, and teacher commissions
3. **Day Use Module** - Day-use package management with add-ons and capacity control

### Key Architectural Patterns

- **Route Groups**: Uses Next.js App Router with route groups for organization:
  - `(auth)` - Authentication routes
  - `(dashboard)` - Protected dashboard routes (cliente/gestor)
  - `(public)` - Public routes (invitations, reservations)

- **Component Organization**: Components organized by module under `src/components/modules/`:
  - `core/` - Reservations, teams, invitations, cost sharing
  - `escolinha/` - Classes, students, attendance
  - `dayuse/` - Packages, check-in

- **Service Layer**: Services organized by module and integrations under `src/services/`

- **Type Safety**: Database types generated by Supabase, custom types per module

### Critical Features

**Autonomous Team System:**
- Teams created independently of reservations (reusable across multiple games)
- Members marked as "fixed" (always included) or "variable"
- Multiple teams per organizer
- One team per reservation

**Flexible Cost Sharing (Rateio):**
- Two modes: Percentage (must sum to 100%) or Fixed Value (sum ≤ reservation total)
- Configuration per reservation (not per team)
- Visual progress indicators
- "Split Equally" helper button

**Public Invitation System:**
- Unique links for each invitation batch
- Multiple batches per reservation
- Landing page for invitation acceptance
- Simplified registration for invitees
- Invitee panel with credit purchase

### User Roles

1. **Cliente (Customer)** - Creates reservations, manages teams, creates invitations
2. **Gestor (Manager)** - Full system access, court management, reports

## Development Commands

### Setup
```bash
# Install dependencies
npm install

# Initialize Supabase locally
supabase init
supabase start

# Generate database types
npx supabase gen types typescript --local > src/types/database.types.ts
```

### Development
```bash
# Run development server
npm run dev

# Build for production
npm run build

# Run production build locally
npm start
```

### Supabase
```bash
# Apply migrations
supabase db push

# Reset database
supabase db reset

# Generate new migration
supabase migration new <migration_name>
```

### shadcn/ui Components
```bash
# Add new component
npx shadcn-ui@latest add <component-name>
```

## Database Structure

### CORE Module Tables
- `users` - User accounts (customers, managers)
- `courts` - Sports courts
- `schedules` - Time slots and pricing
- `reservations` - Court reservations
- `teams` - Autonomous teams (reusable)
- `team_members` - Team members (fixed/variable status)
- `reservation_participants` - Participants per reservation
- `invitations` - Public invitation batches
- `invitation_acceptances` - Accepted invitations
- `payments` - Payment records
- `transactions` - Financial history
- `reviews` - Game reviews
- `referrals` - Referral system

### Important: Row Level Security (RLS)
All tables use Supabase RLS policies to enforce access control. Always test permissions for each user role.

## Critical Implementation Details

### User Registration
- CPF and RG must be unique
- Integration with ViaCEP API for address auto-fill via CEP (postal code)
- Auto-filled fields: logradouro, bairro, cidade, estado

### Reservation Types
1. **Avulsa** - One-time reservation
2. **Mensalista** - Monthly recurring (same day/time each week for a month)
3. **Recorrente** - Custom recurring pattern

### Payment Methods
- Pix
- Credit/Debit card
- Accumulated credits
- Security deposit (caução) with pre-authorization and partial capture

### Cost Sharing Logic
**Percentage Mode:**
- Sum must equal exactly 100%
- Visual indicator of current sum
- Real-time validation

**Fixed Value Mode:**
- Each member assigned specific R$ amount
- If total < reservation cost: organizer pays difference
- If total > reservation cost: validation error
- Members can be set to R$ 0.00 (free)

### WhatsApp Notifications
- Automatic reminders (45min and 10min before game)
- Invitation acceptance notifications
- Post-game review requests
- Uses WhatsApp Business API templates

## Environment Variables

Required variables (see SETUP/PROMPT.md for complete list):
```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
ASAAS_API_KEY=
ASAAS_WALLET_ID=
WHATSAPP_API_TOKEN=
WHATSAPP_PHONE_NUMBER_ID=
NEXT_PUBLIC_APP_URL=
```

## File Organization Conventions

- **Validation schemas**: `src/lib/validations/*.schema.ts` (using Zod)
- **Custom hooks**: `src/hooks/use*.ts`
- **Services**: `src/services/<module>/*.service.ts`
- **Types**: `src/types/*.types.ts`
- **Utilities**: `src/lib/utils/*.ts` (currency, date, CPF validation)

## Design System

Uses shadcn/ui with custom color palette:
- Primary: Green (sports theme) - `142 76% 36%`
- Secondary: Blue (trust) - `217 91% 60%`
- Accent: Orange (energy) - `25 95% 53%`

Mobile-first responsive breakpoints:
- Mobile: 320px - 767px
- Tablet: 768px - 1023px
- Desktop: 1024px+

## Key Integration Services

### Asaas Service (`src/services/integrations/asaas.service.ts`)
- Pix payments
- Credit card payments
- Security deposit (pre-authorization + partial capture)
- Webhook handling

### WhatsApp Service (`src/services/integrations/whatsapp.service.ts`)
- Template message sending
- Invitation notifications
- Reminders
- Review requests

### ViaCEP Service (`src/services/integrations/viacep.service.ts`)
- Address lookup by CEP
- Auto-fill registration form

## Implementation Priority (from PRD)

1. Setup (Next.js + Tailwind + shadcn/ui)
2. Supabase configuration (migrations + RLS)
3. Authentication (login, registration, password recovery)
4. ViaCEP integration
5. Reservation system (selection, calendar, payment)
6. Team system (CRUD)
7. Cost sharing system (UI + logic)
8. Invitation system (creation + acceptance)
9. User panels (organizer, invitee, manager)
10. Integrations (Asaas, WhatsApp)
11. Testing and refinements

## Important Files

- `SETUP/PRD.md` - Complete Product Requirements Document with all user stories
- `SETUP/PROMPT.md` - Detailed technical implementation prompt
- Both files in Portuguese (Brazilian)
